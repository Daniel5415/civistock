{% extends "base.html" %}

{% block content %}
<div class="content-container">
  <div class="d-flex header-reportes mb-3">
    <div class="title-wrapper">
      <h2><i class="fas fa-file-chart-line me-2"></i> Reportes de Obra</h2>
    </div>
    <div class="buttons-group">
      <a href="{{ url_for('ingeniero.dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Volver al dashboard
      </a>
      
      <a href="{{ url_for('ingeniero.realizar_devolucion') }}" class="btn btn-warning">
        <i class="fas fa-undo-alt me-1"></i> Realizar devolución
      </a>
      <a href="{{ url_for('ingeniero.generar_pdf') }}" class="btn btn-primary" target="_blank">
        <i class="fas fa-print me-1"></i> Generar reporte PDF
      </a>
    </div>
  </div>

  <hr>

  <h4 class="section-title"><i class="fas fa-check-circle text-success me-1"></i> Retiros aprobados</h4>
  {% if aprobados %}
    <div class="table-responsive">
      <table class="civistock-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Material</th>
            <th>Cantidad</th>
            <th>Obs. Ingeniero</th>
            <th>Obs. Almacenista</th>
          </tr>
        </thead>
        <tbody>
          {% for mov in aprobados %}
            <tr>
              <td>{{ mov.fecha_local.fecha }} {{ mov.fecha_local.hora }}</td>
              <td>{{ mov.material.nombre }}</td>
              <td>{{ mov.cantidad|formatear_numero }}</td>
              <td>{{ mov.observacion or 'Sin observación' }}</td>
              <td>{{ mov.observacion_almacenista or 'Sin observación' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No hay retiros aprobados este mes.</p>
  {% endif %}

  <hr>

  <h4 class="section-title"><i class="fas fa-times-circle text-danger me-1"></i> Retiros rechazados</h4>
  {% if rechazados %}
    <div class="table-responsive">
      <table class="civistock-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Material</th>
            <th>Cantidad</th>
            <th>Obs. Ingeniero</th>
            <th>Obs. Almacenista</th>
          </tr>
        </thead>
        <tbody>
          {% for mov in rechazados %}
            <tr>
              <td>{{ mov.fecha_local.fecha }} {{ mov.fecha_local.hora }}</td>
              <td>{{ mov.material.nombre }}</td>
              <td>{{ mov.cantidad|formatear_numero }}</td>
              <td>{{ mov.observacion or 'Sin observación' }}</td>
              <td>{{ mov.observacion_almacenista or 'Sin observación' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No hay retiros rechazados este mes.</p>
  {% endif %}

  <hr>

  <h4 class="section-title"><i class="fas fa-undo-alt text-warning me-1"></i> Devoluciones solicitadas</h4>
  {% if devoluciones %}
    <div class="table-responsive">
      <table class="civistock-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Material</th>
            <th>Cantidad</th>
            <th>Estado</th>
            <th>Obs. Ingeniero</th>
            <th>Obs. Almacenista</th>
            <th>Evidencia</th>
          </tr>
        </thead>
        <tbody>
          {% for mov in devoluciones %}
            {% set extension = mov.evidencia.split('.')[-1].lower() if mov.evidencia else '' %}
            <tr>
              <td>{{ mov.fecha_local.fecha }} {{ mov.fecha_local.hora }}</td>
              <td>{{ mov.material.nombre }}</td>
              <td>{{ mov.cantidad|formatear_numero }}</td>
              <td>
                {% if mov.estado == 'AUTORIZADO' %}
                  <span class="badge estado aprobado"><i class="fas fa-check-circle me-1"></i> {{ mov.estado.title() }}</span>
                {% elif mov.estado == 'RECHAZADO' %}
                  <span class="badge estado rechazado"><i class="fas fa-times-circle me-1"></i> {{ mov.estado.title() }}</span>
                {% else %}
                  <span class="badge estado pendiente"><i class="fas fa-clock me-1"></i> {{ mov.estado.title() }}</span>
                {% endif %}
              </td>
              <td>{{ mov.observacion or 'Sin observación' }}</td>
              <td>{{ mov.observacion_almacenista or 'Sin observación' }}</td>
              <td>
                {% if mov.evidencia %}
                  <img src="{% if extension in ['jpg','jpeg','png','gif'] %}{{ url_for('static', filename='evidencias/' ~ mov.evidencia) }}{% else %}{{ url_for('static', filename='icono_pdf.png') }}{% endif %}"
                       alt="Evidencia"
                       class="thumb-evidencia"
                       data-bs-toggle="modal"
                       data-bs-target="#modalEvidencia{{ mov.id }}">
                  <!-- Modal -->
                  <div class="modal fade" id="modalEvidencia{{ mov.id }}" tabindex="-1" aria-labelledby="modalLabel{{ mov.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-xl">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="modalLabel{{ mov.id }}">Evidencia de Devolución</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body text-center">
                          {% if extension in ['jpg','jpeg','png','gif'] %}
                            <img src="{{ url_for('static', filename='evidencias/' ~ mov.evidencia) }}" class="img-fluid rounded" alt="Evidencia">
                          {% elif extension == 'pdf' %}
                            <iframe src="{{ url_for('static', filename='evidencias/' ~ mov.evidencia) }}" width="100%" height="600px" style="border: none;"></iframe>
                          {% else %}
                            <p>No se puede mostrar vista previa. <a href="{{ url_for('static', filename='evidencias/' ~ mov.evidencia) }}" target="_blank">Descargar archivo</a></p>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <span class="text-muted">Sin evidencia</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No hay devoluciones solicitadas este mes.</p>
  {% endif %}
</div>
{% endblock %}
