
{% extends "base.html" %}
{% block title %}Solicitar Retiro{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üì¶ Solicitar Retiro de Material</h2>
        <a href="{{ url_for('ingeniero.dashboard') }}" class="btn btn-secondary">‚Üê Volver al dasboard</a>
    </div>

    <form method="POST" class="card p-4 shadow-sm" id="form-retiro">
        <div class="mb-3">
            <label for="material_id" class="form-label">Buscar Material</label>
            <select name="material_id" id="material_id" class="form-select" required>
                <option value="" disabled selected>Seleccione un material</option>
                {% for m in materiales %}
                    <option value="{{ m.id }}" data-stock="{{ m.stock }}">
                        {{ m.nombre }} (Stock: {{ m.stock|formatear_numero }})
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="cantidad" class="form-label">Cantidad</label>
            <input type="number" name="cantidad" id="cantidad" class="form-control" required min="0" step="any">
            <div id="error-stock" class="mt-1 text-danger" style="display: none; font-size: 0.9em;">
                ‚ö†Ô∏è No hay suficiente stock disponible.
            </div>
        </div>

        <div class="mb-3">
            <label for="observacion" class="form-label">Observaci√≥n</label>
            <textarea name="observacion" class="form-control" rows="3" placeholder="Opcional"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">üì§ Enviar Solicitud</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- jQuery primero -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Luego Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function () {
    // Activar Select2
    $('#material_id').select2({
        placeholder: "Buscar y seleccionar un material",
        width: '100%',
        allowClear: true
    });

    function validarStock() {
        const cantidadSolicitada = parseInt($('#cantidad').val());
        const stock = parseInt($('#material_id option:selected').data('stock'));

        if (!isNaN(cantidadSolicitada) && !isNaN(stock)) {
            if (cantidadSolicitada > stock) {
                $('#error-stock').show();
                return false;
            } else {
                $('#error-stock').hide();
                return true;
            }
        }
        $('#error-stock').hide();
        return true;
    }

    $('#cantidad').on('input', validarStock);
    $('#material_id').on('change', validarStock);

    $('#form-retiro').on('submit', function (e) {
        if (!validarStock()) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
