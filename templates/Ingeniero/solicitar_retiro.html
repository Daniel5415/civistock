
{% extends "base.html" %}
{% block title %}Solicitar Retiro{% endblock %}

{% block content %}
<div >
    <div class=" text">
                <h2 class="mb-4 text-center"><i class="fas fa-box-open me-2"></i> Solicitar Retiro de Material</h2>
    </div>

<div class="mb-4 d-flex justify-content-start">
  <a href="{{ url_for('ingeniero.dashboard') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i> Volver al dashboard
  </a>
</div>

    <form method="POST" class="card p-4 shadow-sm" id="form-retiro">
        <div class="mb-3">
            <label for="material_id" class="form-label">Buscar Material</label>
            <select name="material_id" id="material_id" class="form-select" required>
                <option value="" disabled selected>Seleccione un material</option>
                {% for m in materiales %}
                    <option value="{{ m.id }}" data-stock="{{ m.stock }}">
                        {{ m.nombre }} (Stock: {{ m.stock|formatear_numero }})
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="cantidad" class="form-label">Cantidad</label>
            <input type="number" name="cantidad" id="cantidad" class="form-control" required min="0" step="any">
            <div id="error-stock" class="mt-1 text-danger" style="display: none; font-size: 0.9em;">
                ⚠️ No hay suficiente stock disponible.
            </div>
        </div>

        <div class="mb-3">
            <label for="observacion" class="form-label">Observación</label>
            <textarea name="observacion" class="form-control" rows="3" placeholder="Opcional"></textarea>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn w-100 d-flex justify-content-center align-items-center gap-2">
                <i class="fas fa-paper-plane me-2"></i> Enviar Solicitud
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- jQuery primero -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Luego Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function () {
    // Activar Select2
    $('#material_id').select2({
        placeholder: "Buscar y seleccionar un material",
        width: '100%',
        allowClear: true
    });

    function validarStock() {
        const cantidadSolicitada = parseInt($('#cantidad').val());
        const stock = parseInt($('#material_id option:selected').data('stock'));

        if (!isNaN(cantidadSolicitada) && !isNaN(stock)) {
            if (cantidadSolicitada > stock) {
                $('#error-stock').show();
                return false;
            } else {
                $('#error-stock').hide();
                return true;
            }
        }
        $('#error-stock').hide();
        return true;
    }

    $('#cantidad').on('input', validarStock);
    $('#material_id').on('change', validarStock);

    $('#form-retiro').on('submit', function (e) {
        if (!validarStock()) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
