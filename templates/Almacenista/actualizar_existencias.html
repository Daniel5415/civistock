{% extends 'base.html' %}
{% include "toasts_alertas_almacenista.html" %}

{% block content %}
<div class="container-exis mt-4">

  <a href="{{ url_for('almacenista.dashboard') }}" class="btn btn-secondary mb-3">← Volver al dashboard</a>

  <h2 class="text-center mb-4">Actualizar Existencias</h2>

  <!-- Búsqueda -->
  <div class="form-busqueda mb-3 input-clearable">
    <input 
      type="text" 
      id="busquedaMateriales"
      class="form-control" 
      placeholder="Buscar por nombre, código, descripción o unidad..."
    >
    <button type="button" class="clear-btn" id="clearSearch">&times;</button>
  </div>

  <script>
    const inputBusqueda = document.getElementById('busquedaMateriales');
    const clearBtn = document.getElementById('clearSearch');

    function filtrarCards() {
      const filtro = inputBusqueda.value.toLowerCase();
      const cards = document.querySelectorAll('.material-card');

      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(filtro) ? '' : 'none';
      });

      clearBtn.style.display = filtro ? 'block' : 'none';
    }

    inputBusqueda.addEventListener('input', filtrarCards);
    clearBtn.addEventListener('click', function () {
      inputBusqueda.value = '';
      filtrarCards();
    });
  </script>

  <!-- Lista como tarjetas -->
{% if grupos %}
    <div class="cards-list">
        {% for unidad, mats in grupos.items() %}
            <div class="unidad-group">
                <h3 class="unidad-title">
                    {{ unidad }} 
                    {% set total = mats|length %}
                    <span class="unidad-badge">{{ total }} material{{ 'es' if total != 1 }}</span>
                </h3>
                <div class="cards-list">
                    {% for material in mats %}
                        {% set es_bajo = (material.stock|float) < (material.stock_minimo|float) %}
                        <div class="material-card {% if es_bajo %}low-stock{% endif %}">
                            <div class="field">
                                <strong>Código:</strong> <span>{{ material.codigo }}</span>
                            </div>
                            <div class="field">
                                <strong>Nombre:</strong> <span>{{ material.nombre }}</span>
                            </div>
                            <div class="field">
                                <strong>Descripción:</strong> <span>{{ material.descripcion }}</span>
                            </div>
                            <div class="field">
                                <strong>Stock mínimo:</strong> <span>{{ material.stock_minimo|formatear_numero }}</span>
                            </div>
                            <div class="field">
                                <strong>Stock actual:</strong> <span>{{ material.stock|formatear_numero }}</span>
                            </div>

                            <div class="field" style="margin-top:6px;">
                                <form method="POST" action="{{ url_for('almacenista.actualizar_existencia_individual', material_id=material.id) }}" class="update-stock-form">
                                    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                                        <div style="flex:1; min-width:100px;">
                                            <label class="visually-hidden" for="nuevo_stock_{{ material.id }}">Nuevo stock</label>
                                            <input 
                                                type="number" 
                                                id="nuevo_stock_{{ material.id }}"
                                                name="nuevo_stock" 
                                                value="{{ material.stock|formatear_numero }}" 
                                                step="any" 
                                                required 
                                                class="form-control"
                                            >
                                        </div>
                                        <div>
                                            <button type="submit" class="btn btn-primary">
                                                Actualizar
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}

    </div>
{% else %}
    <p>No hay materiales registrados aún.</p>
{% endif %}

</div>
<script>
document.querySelectorAll('.unidad-title .toggle-group').forEach(btn => {
  btn.addEventListener('click', () => {
    const group = btn.closest('.unidad-group');
    const list = group.querySelector('.cards-list');
    const expanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', !expanded);
    btn.querySelector('i').classList.toggle('fa-chevron-up', expanded);
    btn.querySelector('i').classList.toggle('fa-chevron-down', !expanded);
    list.style.display = expanded ? 'none' : 'grid';
  });
});
</script>

{% endblock %}
