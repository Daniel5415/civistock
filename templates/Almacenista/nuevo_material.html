{% extends "base.html" %}
{% include "toasts_alertas_almacenista.html" %}
{% block title %}Gesti√≥n de Materiales{% endblock %}

{% block content %}
  <div class="welcome-text">
    <h2>Gesti√≥n de Materiales</h2>
    <p>Ingresa nuevos materiales y consulta el inventario existente en un solo lugar.</p>
  </div>

  <!-- BOT√ìN VOLVER -->
  <a class="volver-button" href="{{ url_for('almacenista.dashboard') }}">
    ‚¨Ö Regresar al men√∫ principal
  </a>

  <!-- FORMULARIO DE INGRESO -->
  <section class="content-container">
    <h3>Ingresar Nuevo Material</h3>
    <form method="POST" class="formulario">
      <label for="codigo">C√≥digo</label>
      <input type="text" id="codigo" name="codigo" placeholder="C√≥digo del material" required>

      <label for="nombre">Nombre del material</label>
      <input type="text" id="nombre" name="nombre" placeholder="Nombre del material" required>

      <label for="descripcion">Descripci√≥n</label>
      <input type="text" id="descripcion" name="descripcion" placeholder="Descripci√≥n">
      
      <label for="unidad">Unidad</label>
      <select id="unidad" name="unidad" required>
        <option value="">-- Selecciona unidad --</option>
        <option value="UND">Unidad (UND)</option>
        <option value="KG">Kilogramo (KG)</option>
        <option value="M3">Metro c√∫bico (M3)</option>
        <option value="M2">Metro cuadrado (M2)</option>
        <option value="ML">Metro lineal (ML)</option>
        <option value="L">Litros (L)</option>
      </select>

      <label for="stock">Cantidad inicial</label>
      <input type="number" id="stock" name="stock" placeholder="Cantidad inicial" step="any" min="0">

      <label for="stock_minimo">Stock m√≠nimo</label>
      <input type="number" id="stock_minimo" name="stock_minimo" placeholder="Stock m√≠nimo" required min="0">

      <button type="submit">Agregar Material</button>
    </form>
  </section>

  <!-- TABLA DE MATERIALES -->
  <section class="content-container">
    <h3>Materiales Registrados</h3>

    <div class="form-busqueda mb-3 d-flex input-clearable">
      <input 
          type="text" 
          id="busquedaMateriales"
          class="form-control me-2" 
          placeholder="Buscar por nombre, c√≥digo, descripci√≥n o unidad..."
      >
      <button type="button" class="clear-btn" id="clearSearch">&times;</button>
    </div>

    <script>
      const inputBusqueda = document.getElementById('busquedaMateriales');
      const clearBtn = document.getElementById('clearSearch');

      function filtrarFilas() {
        const filtro = inputBusqueda.value.toLowerCase();
        const filas = document.querySelectorAll('table tbody tr');

        filas.forEach(fila => {
          const textoFila = fila.textContent.toLowerCase();
          fila.style.display = textoFila.includes(filtro) ? '' : 'none';
        });

        clearBtn.style.display = filtro ? 'block' : 'none';
      }

      inputBusqueda.addEventListener('input', filtrarFilas);

      clearBtn.addEventListener('click', function () {
        inputBusqueda.value = '';
        filtrarFilas();
      });
    </script>

    {% if materiales %}
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Unidad</th>
            <th>Stock</th>
            <th>Stock m√≠nimo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for material in materiales %}
            <tr>
              <td>{{ material.codigo }}</td>
              <td>{{ material.nombre }}</td>
              <td>{{ material.descripcion }}</td>
              <td>{{ material.unidad }}</td>
              <td>{{ material.stock|formatear_numero }}</td>
              <td>{{ material.stock_minimo }}</td>
              <td>
                <div class="action-buttons">
                  <a href="{{ url_for('almacenista.editar_material', id=material.id) }}" class="icon-button" title="Editar">
                    <i class="fas fa-pencil-alt"></i>
                  </a>
                  <button type="button" class="icon-button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-id="{{ material.id }}">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No hay materiales registrados a√∫n.</p>
    {% endif %}

    <!-- üîΩ MODAL directamente aqu√≠ -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning text-white">
            <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar eliminaci√≥n</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            ¬øEst√°s seguro de que deseas eliminar este material? Esta acci√≥n no se puede deshacer.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form id="deleteForm" method="POST" data-base-url="{{ url_for('almacenista.eliminar_material', id=0)[:-1] }}">
              <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const confirmDeleteModal = document.getElementById('confirmDeleteModal');

      confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        if (!button) return;

        const materialId = button.getAttribute('data-id');
        const form = confirmDeleteModal.querySelector('#deleteForm');
        const baseUrl = form.getAttribute('data-base-url');

        form.action = baseUrl + materialId;
      });
    });
  </script>
{% endblock %}
