{% extends "base.html" %}
{% include "toasts_alertas_almacenista.html" %}
{% block title %}Existencias - CIVISTOCK{% endblock %}

{% block content %}

  <div class="container mt-5">
    <h2 class="mb-4">Existencias Generales</h2>
    <a href="{{ url_for('almacenista.dashboard') }}" class="btn btn-primary mb-4">← Volver al dashboard</a>

    <div class="input-group mb-4" style="max-width: 400px;">
      <input type="text" id="filtroGlobal" class="form-control" placeholder="Buscar en todas las tablas...">
      <button class="btn btn-outline-secondary" type="button" id="limpiarBusqueda">✕</button>
    </div>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>Descripción</th>
          <th>Unidad</th>
          <th>Cantidad Disponible</th>
        </tr>
      </thead>
      <tbody>
        {% for material in materiales %}
          <tr>
            <td>{{ material.codigo }}</td>
            <td>{{ material.nombre }}</td>
            <td>{{ material.descripcion }}</td>
            <td>{{ material.unidad }}</td>
            <td>{{ material.stock|formatear_numero }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if materiales_en_devolucion %}
      <h2 class="mt-5">Materiales en Devolución</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>Motivo</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in materiales_en_devolucion %}
            <tr>
              <td>{{ item.material.codigo }}</td>
              <td>{{ item.material.nombre }}</td>
              <td>{{ item.material.descripcion }}</td>
              <td>{{ item.material.unidad }}</td>
              <td>{{ item.cantidad|formatear_numero }}</td>
              <td>{{ item.observacion or '' }}</td>
              <td>{{ item.fecha_local.fecha }} {{ item.fecha_local.hora }}</td>
              <td>
                <form method="POST" action="{{ url_for('almacenista.retornar_a_stock', movimiento_id=item.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-success btn-sm">Retornar al stock</button>
                </form>
                <form method="POST" action="{{ url_for('almacenista.enviar_a_ferreteria', movimiento_id=item.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-warning btn-sm">Enviar a ferretería</button>
                </form>
                <form method="POST" action="{{ url_for('almacenista.descartar_devolucion', movimiento_id=item.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-danger btn-sm">Descartar</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    {% if enviados_ferreteria %}
      <h2 class="mt-5">Materiales Enviados a Ferretería</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>Motivo</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in enviados_ferreteria %}
            <tr>
              <td>{{ item.material.codigo }}</td>
              <td>{{ item.material.nombre }}</td>
              <td>{{ item.material.descripcion }}</td>
              <td>{{ item.material.unidad }}</td>
              <td>{{ item.cantidad|formatear_numero }}</td>
              <td>{{ item.observacion or '' }}</td>
              <td>{{ item.fecha_local.fecha }} {{ item.fecha_local.hora }}</td>
              <td>
                <form method="POST" action="{{ url_for('almacenista.aprobar_ferreteria', movimiento_id=item.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-success btn-sm">Aprobar</button>
                </form>
                <form method="POST" action="{{ url_for('almacenista.rechazar_ferreteria', movimiento_id=item.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-danger btn-sm">Rechazar</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    {% if materiales_aprobados_ferreteria %}
      <h2 class="mt-5">Materiales Aprobados por Ferretería</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>Motivo</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for item in materiales_aprobados_ferreteria %}
            <tr>
              <td>{{ item.material.codigo }}</td>
              <td>{{ item.material.nombre }}</td>
              <td>{{ item.material.descripcion }}</td>
              <td>{{ item.material.unidad }}</td>
              <td>{{ item.cantidad|formatear_numero }}</td>
              <td>{{ item.observacion or '' }}</td>
              <td>{{ item.fecha_local.fecha }} {{ item.fecha_local.hora }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    {% if rechazados %}
      <h2 class="mt-5">Materiales Rechazados o Descartados</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>Motivo</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for item in rechazados %}
            <tr>
              <td>{{ item.material.codigo }}</td>
              <td>{{ item.material.nombre }}</td>
              <td>{{ item.material.descripcion }}</td>
              <td>{{ item.material.unidad }}</td>
              <td>{{ item.cantidad|formatear_numero }}</td>
              <td>
                {{ item.observacion or '' }}
                {% if item.estado == 'DESCARTADO' %}
                  <br><strong>(Material descartado)</strong>
                {% elif item.estado == 'RECHAZADO_FERRETERIA' %}
                  <br><strong>(Rechazado por ferretería)</strong>
                {% endif %}
              </td>
              <td>{{ item.fecha_local.fecha }} {{ item.fecha_local.hora }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('filtroGlobal');
    const limpiarBtn = document.getElementById('limpiarBusqueda');

    // Filtrado global
    input.addEventListener('input', function () {
      const filtro = this.value.toLowerCase();
      const tablas = document.querySelectorAll('table');

      tablas.forEach(tabla => {
        const filas = tabla.querySelectorAll('tbody tr');
        filas.forEach(fila => {
          const textoFila = fila.textContent.toLowerCase();
          fila.style.display = textoFila.includes(filtro) ? '' : 'none';
        });
      });
    });

    // Limpieza del input
    limpiarBtn.addEventListener('click', function () {
      input.value = '';
      input.dispatchEvent(new Event('input')); // Reaplica el filtro
      input.focus();
    });
  });
</script>

{% endblock %}
