{% extends 'base.html' %}
{% include "toasts_alertas_almacenista.html" %}
{% block title %}Reportes Mensuales{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header: título y navegación -->
  <div class="header-wrapper mb-4" style="justify-content: space-between; gap: 12px;">
    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
      <a href="{{ url_for('almacenista.dashboard') }}" class="btn btn-secondary">
        ← Volver al dashboard
      </a>
      <h2 class="mb-0">
        <i class="fas fa-chart-line" aria-hidden="true"></i> Reporte mensual - {{ mes }}/{{ anio }}
      </h2>
    </div>
    <div>
      <a href="{{ url_for('almacenista.revisar_devoluciones') }}" class="btn btn-info">
        <i class="fas fa-folder-open" aria-hidden="true"></i> Revisar Devoluciones Pendientes
      </a>
    </div>
  </div>

  <!-- Retiros Aprobados -->
  <h4 class="text-success">
    <i class="fas fa-check-circle" aria-hidden="true"></i> Retiros Aprobados
  </h4>
  {% if aprobados %}
    <div class="table-responsive">
      <div class="table-scroll">
        <table class="table table-bordered table-striped" aria-label="Retiros aprobados">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Material</th>
              <th>Cantidad</th>
              <th>Solicitado por</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in aprobados %}
              <tr>
                <td data-label="Fecha">{{ mov.fecha_local.fecha }} {{ mov.fecha_local.hora }}</td>
                <td data-label="Material">{{ mov.material.nombre }}</td>
                <td data-label="Cantidad">{{ mov.cantidad|formatear_numero }} {{ mov.material.unidad }}</td>
                <td data-label="Solicitado por">{{ mov.usuario.nombre }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <p>No hay retiros aprobados este mes.</p>
  {% endif %}

  <!-- Retiros Rechazados -->
  <h4 class="mb-2" style="color: #ee7021;">
    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Retiros Rechazados
  </h4>
  {% if rechazados %}
    <div class="table-responsive">
      <div class="table-scroll">
        <table class="table table-bordered table-striped" aria-label="Retiros rechazados">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Material</th>
              <th>Cantidad</th>
              <th>Solicitado por</th>
              <th>Observación del Almacenista</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in rechazados %}
              <tr>
                <td data-label="Fecha">{{ mov.fecha_local.fecha }} {{ mov.fecha_local.hora }}</td>
                <td data-label="Material">{{ mov.material.nombre }}</td>
                <td data-label="Cantidad">{{ mov.cantidad|formatear_numero }} {{ mov.material.unidad }}</td>
                <td data-label="Solicitado por">{{ mov.usuario.nombre }}</td>
                <td data-label="Observación del Almacenista">{{ mov.observacion_almacenista or 'Sin observación' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <p>No hay retiros rechazados este mes.</p>
  {% endif %}

  <!-- Devoluciones -->
  <h4 class="mb-2" style="color: #0d47a1;">
    <i class="fas fa-recycle" aria-hidden="true"></i> Devoluciones
  </h4>
  {% if devoluciones %}
    <div class="table-responsive">
      <div class="table-scroll">
        <table class="table table-bordered table-striped" aria-label="Devoluciones">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Material</th>
              <th>Cantidad</th>
              <th>Solicitado por</th>
              <th>Estado</th>
              <th>Observación del Ingeniero</th>
              <th>Observación del Almacenista</th>
              <th>Evidencia</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in devoluciones %}
              <tr>
                <td data-label="Fecha">{{ mov.fecha_local.fecha }} {{ mov.fecha_local.hora }}</td>
                <td data-label="Material">{{ mov.material.nombre }}</td>
                <td data-label="Cantidad">{{ mov.cantidad|formatear_numero }} {{ mov.material.unidad }}</td>
                <td data-label="Solicitado por">{{ mov.usuario.nombre }}</td>
                <td data-label="Estado">{{ mov.estado }}</td>
                <td data-label="Observación del Ingeniero">{{ mov.observacion or 'Sin observación' }}</td>
                <td data-label="Observación del Almacenista">{{ mov.observacion_almacenista or 'Sin observación' }}</td>
                <td data-label="Evidencia">
                  {% if mov.evidencia %}
                    {% set extension = mov.evidencia.split('.')[-1].lower() %}
                    {% set ruta = 'evidencias/' + mov.evidencia %}

                    {% if extension in ['jpg', 'jpeg', 'png', 'gif'] %}
                      <img src="{{ url_for('static', filename=ruta) }}"
                           class="img-thumbnail"
                           width="80"
                           data-bs-toggle="modal"
                           data-bs-target="#visor{{ loop.index }}"
                           alt="Evidencia imagen {{ loop.index }}">

                      <div class="modal fade" id="visor{{ loop.index }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title">Vista de Evidencia</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body text-center">
                              <img src="{{ url_for('static', filename=ruta) }}" class="img-fluid" alt="Evidencia ampliada">
                            </div>
                          </div>
                        </div>
                      </div>

                    {% elif extension == 'pdf' %}
                      <button class="btn btn-outline-danger btn-sm"
                              data-bs-toggle="modal"
                              data-bs-target="#visor{{ loop.index }}">
                        Ver PDF
                      </button>

                      <div class="modal fade" id="visor{{ loop.index }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-xl modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title">Vista de PDF</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body" style="height: 80vh;">
                              <iframe src="{{ url_for('static', filename=ruta) }}"
                                      width="100%"
                                      height="100%"
                                      frameborder="0"
                                      aria-label="PDF de evidencia"></iframe>
                            </div>
                          </div>
                        </div>
                      </div>

                    {% else %}
                      <span class="text-muted">Archivo no compatible</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Sin evidencia</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <p>No hay devoluciones registradas este mes.</p>
  {% endif %}
</div>
{% endblock %}
